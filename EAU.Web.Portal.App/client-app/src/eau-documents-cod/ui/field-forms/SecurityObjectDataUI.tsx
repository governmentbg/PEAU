import { BaseProps, ViewMode } from "cnsys-ui-react";
import { attributesClassFormControlRequiredLabel, EAUBaseComponent, ResourceHelpers, ValidationSummary, ValidationSummaryStrategy, attributesClassFormControlReadOnly, attributesClassFormControlLabel } from "eau-core";
import { ApplicationFormManagerProps, withCollectionItems, withDocumentFormManager } from "eau-documents";
import { action, observable } from "mobx";
import { observer } from "mobx-react";
import React from "react";
import { ArrayHelper, ObjectHelper, SelectListItem } from "cnsys-core";
import { isNotificationForTakingOrRemovingFromSecurityManager } from "../../form-managers/NotificationForTakingOrRemovingFromSecurityManager";
import { PointOfPrivateSecurityServicesLaw, SecurityObject, ProtectionOfAgriculturalProperty, SecurityTransport, AlarmAndSecurityActivity, SecurityOfEvents, ProtectionPersonsProperty, SecurityOfSitesRealEstate, SecurityTransportingCargo, PersonalSecurity } from "../../models/ModelsAutoGenerated";
import { SecurityObjectType4, SecurityObjectType9, SecurityObjectType3, SecurityObjectType2, SecurityObjectType5, SecurityObjectType7, SecurityObjectType8, SecurityObjectType1 } from "./security-objects";

interface SecurityObjectDataProps extends BaseProps, ApplicationFormManagerProps {
}

@observer export class SecurityObjectDataImpl extends EAUBaseComponent<SecurityObjectDataProps, SecurityObject> {

    private pointOfPrivateSecurityServicesLawItems: SelectListItem[];
    private isForTermination: boolean;
    @observable private aisChodObjectID: string;

    constructor(props: SecurityObjectDataProps) {
        super(props);

        this.handlePointOfPrivateSecurityServicesLawChange = this.handlePointOfPrivateSecurityServicesLawChange.bind(this);
        this.getAisChodObjectID = this.getAisChodObjectID.bind(this);

        this.aisChodObjectID = this.getAisChodObjectID();

        let points = [];

        if (isNotificationForTakingOrRemovingFromSecurityManager(this.props.documentFormManager)) {
            points = this.props.documentFormManager.getPointOfPrivateSecurityServicesLaw();

            if (!this.model.selfProtectionPersonsProperty)
                this.props.documentFormManager.initSecurityObject(this.model);

            this.isForTermination = this.props.documentFormManager.isTerminationNotification();
        }

        if (points && points.length > 0) {
            this.pointOfPrivateSecurityServicesLawItems = ArrayHelper.queryable.from(points).select(el => {
                let tmpItem = new SelectListItem({
                    text: ResourceHelpers.getResourceByEmun(el as number, PointOfPrivateSecurityServicesLaw),
                    value: el.toString()
                });

                if (points.length == 1) {
                    tmpItem.selected = true;
                }

                return tmpItem;
            }).toArray();
        } else {
            this.pointOfPrivateSecurityServicesLawItems = [];
        }

    }

    renderEdit(): JSX.Element {
        return (
            <>
                
                <ValidationSummary model={this.model} {...this.props} strategy={ValidationSummaryStrategy.includeOnlyModelErrors} />
                <div className="row">
                    <div className="form-group col-12">
                        {this.labelFor(m => m.pointOfPrivateSecurityServicesLaw, null, !ObjectHelper.isStringNullOrEmpty(this.aisChodObjectID) ? attributesClassFormControlLabel : attributesClassFormControlRequiredLabel)}
                        {this.pointOfPrivateSecurityServicesLawItems.length > 1 ?
                            this.dropDownListFor(m => m.pointOfPrivateSecurityServicesLaw, this.pointOfPrivateSecurityServicesLawItems, !ObjectHelper.isStringNullOrEmpty(this.aisChodObjectID) ? attributesClassFormControlReadOnly : null , this.handlePointOfPrivateSecurityServicesLawChange, true, this.getResource('GL_CHOICE_L'))
                            : this.dropDownListFor(m => m.pointOfPrivateSecurityServicesLaw, this.pointOfPrivateSecurityServicesLawItems, !ObjectHelper.isStringNullOrEmpty(this.aisChodObjectID) ? attributesClassFormControlReadOnly : null)}
                    </div>
                </div>
                
                {this.model.selfProtectionPersonsProperty && <SecurityObjectType4 {...this.bind(x => x.selfProtectionPersonsProperty)} isForTermination={this.isForTermination} />}
                {this.model.protectionOfAgriculturalProperty && <SecurityObjectType9 {...this.bind(x => x.protectionOfAgriculturalProperty)} isForTermination={this.isForTermination} />}
                {this.model.alarmAndSecurityActivity && <SecurityObjectType3 {...this.bind(x => x.alarmAndSecurityActivity)} isForTermination={this.isForTermination} />}
                {this.model.protectionPersonsProperty && <SecurityObjectType2 {...this.bind(x => x.protectionPersonsProperty)} isForTermination={this.isForTermination} />}
                {this.model.securityOfSitesRealEstate && <SecurityObjectType5 {...this.bind(x => x.securityOfSitesRealEstate)} isForTermination={this.isForTermination} />}
                {this.model.securityOfEvents && <SecurityObjectType7 {...this.bind(x => x.securityOfEvents)} isForTermination={this.isForTermination} />}
                {this.model.securityTransportingCargo && <SecurityObjectType8 {...this.bind(x => x.securityTransportingCargo)} isForTermination={this.isForTermination} />}
                {this.model.personalSecurity && <SecurityObjectType1 {...this.bind(x => x.personalSecurity)} isForTermination={this.isForTermination} />}
            </>
        );
    }

    renderDisplay(): JSX.Element {
        return (
            <>
                <div className="row">
                    <div className="form-group col-12">
                        <ValidationSummary model={this.model} {...this.props} strategy={ValidationSummaryStrategy.includeOnlyModelErrors} viewMode={ViewMode.Display} />
                    </div>
                </div>  
                <div className="row">
                    <div className="form-group col-12">
                        <h4 className="form-control-label">{this.getResourceByProperty(m => m.pointOfPrivateSecurityServicesLaw)}</h4>
                        {ResourceHelpers.getResourceByEmun(this.model.pointOfPrivateSecurityServicesLaw as number, PointOfPrivateSecurityServicesLaw)}
                        {this.propertyErrorsDispleyFor(m => m.pointOfPrivateSecurityServicesLaw)}
                    </div>
                </div>
                {this.model.selfProtectionPersonsProperty && <SecurityObjectType4 {...this.bind(x => x.selfProtectionPersonsProperty)} isForTermination={this.isForTermination} />}
                {this.model.protectionOfAgriculturalProperty && <SecurityObjectType9 {...this.bind(x => x.protectionOfAgriculturalProperty)} isForTermination={this.isForTermination} />}
                {this.model.alarmAndSecurityActivity && <SecurityObjectType3 {...this.bind(x => x.alarmAndSecurityActivity)} isForTermination={this.isForTermination} />}
                {this.model.protectionPersonsProperty && <SecurityObjectType2 {...this.bind(x => x.protectionPersonsProperty)} isForTermination={this.isForTermination} />}
                {this.model.securityOfSitesRealEstate && <SecurityObjectType5 {...this.bind(x => x.securityOfSitesRealEstate)} isForTermination={this.isForTermination} />}
                {this.model.securityOfEvents && <SecurityObjectType7 {...this.bind(x => x.securityOfEvents)} isForTermination={this.isForTermination} />}
                {this.model.securityTransportingCargo && <SecurityObjectType8 {...this.bind(x => x.securityTransportingCargo)} isForTermination={this.isForTermination} />}
                {this.model.personalSecurity && <SecurityObjectType1 {...this.bind(x => x.personalSecurity)} isForTermination={this.isForTermination} />}
            </>
        );
    }

    private getAisChodObjectID () {

        let aisChodObjectID:string = '';

        if (!ObjectHelper.isNullOrUndefined(this.model.pointOfPrivateSecurityServicesLaw)) {

            switch (this.model.pointOfPrivateSecurityServicesLaw) {

                case PointOfPrivateSecurityServicesLaw.PersonalSecurityServicesForPersons:
                    if (!ObjectHelper.isNullOrUndefined(this.model.personalSecurity) && !ObjectHelper.isNullOrUndefined(this.model.personalSecurity.aischodObjectID))
                        aisChodObjectID = this.model.personalSecurity.aischodObjectID;
                break;

                case PointOfPrivateSecurityServicesLaw.PropertySecurityServices:
                    if (!ObjectHelper.isNullOrUndefined(this.model.protectionPersonsProperty) && !ObjectHelper.isNullOrUndefined(this.model.protectionPersonsProperty.aischodObjectID))
                        aisChodObjectID = this.model.protectionPersonsProperty.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.AlarmAndSecurityActivity:
                    if (!ObjectHelper.isNullOrUndefined(this.model.alarmAndSecurityActivity) && !ObjectHelper.isNullOrUndefined(this.model.alarmAndSecurityActivity.aischodObjectID))
                        aisChodObjectID = this.model.alarmAndSecurityActivity.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.EntityPropertySelfProtection:
                    if (!ObjectHelper.isNullOrUndefined(this.model.selfProtectionPersonsProperty) && !ObjectHelper.isNullOrUndefined(this.model.selfProtectionPersonsProperty.aischodObjectID))
                        aisChodObjectID = this.model.selfProtectionPersonsProperty.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.RealEstatSecurity:
                    if (!ObjectHelper.isNullOrUndefined(this.model.securityOfSitesRealEstate) && !ObjectHelper.isNullOrUndefined(this.model.securityOfSitesRealEstate.aischodObjectID))
                        aisChodObjectID = this.model.securityOfSitesRealEstate.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.EventsSecurityServices:
                    if (!ObjectHelper.isNullOrUndefined(this.model.securityOfEvents) && !ObjectHelper.isNullOrUndefined(this.model.securityOfEvents.aischodObjectID))
                        aisChodObjectID = this.model.securityOfEvents.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.ValuablesAndCargoesSecurityServices:
                    if (!ObjectHelper.isNullOrUndefined(this.model.securityTransportingCargo) && !ObjectHelper.isNullOrUndefined(this.model.securityTransportingCargo.aischodObjectID))
                        aisChodObjectID = this.model.securityTransportingCargo.aischodObjectID;
                    break;

                case PointOfPrivateSecurityServicesLaw.AgriculturalAndPropertyProtection:
                    if (!ObjectHelper.isNullOrUndefined(this.model.protectionOfAgriculturalProperty) && !ObjectHelper.isNullOrUndefined(this.model.protectionOfAgriculturalProperty.aischodObjectID))
                        aisChodObjectID = this.model.protectionOfAgriculturalProperty.aischodObjectID;
                    break;

                default:
                    aisChodObjectID = null;
            }
        }

        return aisChodObjectID;
    }

    @action private handlePointOfPrivateSecurityServicesLawChange() {
        this.model.personalSecurity = null;
        this.model.protectionPersonsProperty = null;
        this.model.alarmAndSecurityActivity = null;
        this.model.selfProtectionPersonsProperty = null;
        this.model.securityOfSitesRealEstate = null;
        this.model.securityOfEvents = null;
        this.model.securityTransportingCargo = null;
        this.model.protectionOfAgriculturalProperty = null;

        if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.AgriculturalAndPropertyProtection) {
            this.model.protectionOfAgriculturalProperty = new ProtectionOfAgriculturalProperty();
            this.model.protectionOfAgriculturalProperty.securityTransports = []
            this.model.protectionOfAgriculturalProperty.securityTransports.push(new SecurityTransport());
        }
        else if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.AlarmAndSecurityActivity) {
            this.model.alarmAndSecurityActivity = new AlarmAndSecurityActivity();
            this.model.alarmAndSecurityActivity.securityTransports = []
            this.model.alarmAndSecurityActivity.securityTransports.push(new SecurityTransport());
        }
        else if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.PropertySecurityServices) {
            this.model.protectionPersonsProperty = new ProtectionPersonsProperty();
            this.model.protectionPersonsProperty.securityTransports = []
            this.model.protectionPersonsProperty.securityTransports.push(new SecurityTransport());
        }
        else if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.RealEstatSecurity) {
            this.model.securityOfSitesRealEstate = new SecurityOfSitesRealEstate();
            this.model.securityOfSitesRealEstate.securityTransports = []
            this.model.securityOfSitesRealEstate.securityTransports.push(new SecurityTransport());
        }
        else if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.EventsSecurityServices) {
            this.model.securityOfEvents = new SecurityOfEvents();
            this.model.securityOfEvents.securityTransports = []
            this.model.securityOfEvents.securityTransports.push(new SecurityTransport());
        }
        else
            if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.ValuablesAndCargoesSecurityServices) {
                this.model.securityTransportingCargo = new SecurityTransportingCargo();
                this.model.securityTransportingCargo.securityTransports = []
                this.model.securityTransportingCargo.securityTransports.push(new SecurityTransport());
            }
            else
                if (this.model.pointOfPrivateSecurityServicesLaw == PointOfPrivateSecurityServicesLaw.PersonalSecurityServicesForPersons) {
                    this.model.personalSecurity = new PersonalSecurity();
                    this.model.personalSecurity.securityTransports = []
                    this.model.personalSecurity.securityTransports.push(new SecurityTransport());
                }
    }
}

export const SecurityObjectDataUI = withDocumentFormManager(withCollectionItems(SecurityObjectDataImpl, {
    initItem: () => new SecurityObject(),
    addButtonLabelKey: 'GL_ADD_SECURITY_OBJECT_L'
}));

export const SecurityObjectDataTerminationUI = withDocumentFormManager(withCollectionItems(SecurityObjectDataImpl, {
    initItem: () => new SecurityObject(),
    addButtonLabelKey: null,
    skipButton: true,
    showDeleteButtonOnSingleElement: true
}));