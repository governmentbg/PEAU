import { ObjectHelper } from "cnsys-core";
import { BaseProps, ViewMode } from "cnsys-ui-react";
import { EAUBaseComponent, ResourceHelpers, ValidationSummary, ValidationSummaryStrategy } from "eau-core";
import { ApplicationFormManagerProps, ApplicationFormVMBase, ApplicationType, EntityBasicData, FieldFormUI, PoliceDepartmentUI, withDocumentFormManager } from "eau-documents";
import { action } from "mobx";
import { observer } from "mobx-react";
import React from "react";
import { ContractType, Employee, EmployeeIdentifierType, NewEmployeeRequest, NotificationForConcludingOrTerminatingEmploymentContractDataVM, NotificationForTakingOrRemovingFromSecurityVM, NotificationOfEmploymentContractType, RemoveEmployeeRequest } from "../../models/ModelsAutoGenerated";
import { NewEmployeeRequestsUI } from "../field-forms/NewEmployeeRequestsUI";
import { RemoveEmployeeRequestsUI } from "../field-forms/RemoveEmployeeRequestsUI";
import { RemoveEmployeeRequestsWrapperUI } from "../field-forms/RemoveEmployeeRequestsWrapperUI";

interface NotificationForConcludingOrTerminatingEmploymentContractDataProps extends BaseProps, ApplicationFormManagerProps {
}

@observer export class NotificationForConcludingOrTerminatingEmploymentContractDataImpl
    extends EAUBaseComponent<NotificationForConcludingOrTerminatingEmploymentContractDataProps, NotificationForConcludingOrTerminatingEmploymentContractDataVM> {


    private applicant: EntityBasicData;
    constructor(props: NotificationForConcludingOrTerminatingEmploymentContractDataProps) {
        super(props)

        this.onContractTypeChange = this.onContractTypeChange.bind(this);

        let app = this.props.documentFormManager.documentForm as NotificationForTakingOrRemovingFromSecurityVM;
        this.applicant = app.electronicServiceApplicant.recipientGroup.recipient.itemEntityBasicData;

    }

    renderEdit(): JSX.Element {
        return (
            <>
                {
                    this.props.documentFormManager.applicationType != ApplicationType.AppForFirstReg
                        ? <FieldFormUI title={this.getResourceByProperty(m => m.issuingPoliceDepartment)}>
                            <PoliceDepartmentUI {...this.bind(m => m.issuingPoliceDepartment, ViewMode.Display)} />
                        </FieldFormUI>
                        : <FieldFormUI title={this.getResourceByProperty(m => m.issuingPoliceDepartment)} required>
                            <PoliceDepartmentUI {...this.bind(m => m.issuingPoliceDepartment)} />
                        </FieldFormUI>
                }
                <FieldFormUI title={this.getResourceByProperty(m => m.notificationOfEmploymentContractType)}>
                    {this.radioButtonListFor(m => m.notificationOfEmploymentContractType, ResourceHelpers.getSelectListItemsForEnum(NotificationOfEmploymentContractType), null, this.onContractTypeChange)}
                </FieldFormUI>
                {
                    this.model.notificationOfEmploymentContractType == NotificationOfEmploymentContractType.Concluding
                        ? <FieldFormUI title={this.getResourceByProperty(m => m.newEmployeeRequests)}>
                            <NewEmployeeRequestsUI {...this.bind(m => m.newEmployeeRequests)} />
                        </FieldFormUI>
                        : <FieldFormUI title={this.getResourceByProperty(m => m.removeEmployeeRequests)}>
                            {this.model.removeEmployeeRequests.length === 0 && <ValidationSummary model={this.model} strategy={ValidationSummaryStrategy.excludeAllExcept} propNames={["removeEmployeeRequests"]} />}
                            <RemoveEmployeeRequestsWrapperUI {...this.bind(m => m)} applicant={this.applicant} />
                           
                        </FieldFormUI>
                }
            </>
        );
    }

    renderDisplay(): JSX.Element {



        return (
            <>
                <FieldFormUI title={this.getResourceByProperty(m => m.issuingPoliceDepartment)}>
                    <PoliceDepartmentUI {...this.bind(m => m.issuingPoliceDepartment)} />
                    {this.propertyErrorsDispleyFor(m => m.issuingPoliceDepartment)}
                </FieldFormUI>
                <FieldFormUI title={this.getResourceByProperty(m => m.notificationOfEmploymentContractType)}>
                    <div className="row">
                        <div className="form-group col-12">
                            <p className="field-text">{ResourceHelpers.getResourceByEmun(this.model.notificationOfEmploymentContractType, NotificationOfEmploymentContractType)}</p>
                        </div>
                    </div>
                </FieldFormUI>
                {
                    this.model.notificationOfEmploymentContractType == NotificationOfEmploymentContractType.Concluding
                        ? <FieldFormUI title={this.getResourceByProperty(m => m.newEmployeeRequests)}>
                            <NewEmployeeRequestsUI {...this.bind(m => m.newEmployeeRequests)} />
                        </FieldFormUI>
                        : <FieldFormUI title={this.getResourceByProperty(m => m.removeEmployeeRequests)}>
                            {this.model.removeEmployeeRequests.length === 0 && <ValidationSummary model={this.model} strategy={ValidationSummaryStrategy.excludeAllExcept} propNames={["removeEmployeeRequests"]} />}
                            <RemoveEmployeeRequestsUI {...this.bind(m => m.removeEmployeeRequests)} />
                        </FieldFormUI>
                }
            </>
        );
    }

    //#region handlers 

    private onContractTypeChange(e: any) {
        this.initEmployeeRequests();
    }

    @action private initEmployeeRequests() {

        this.model.newEmployeeRequests = null;
        this.model.removeEmployeeRequests = null

        if (this.model.notificationOfEmploymentContractType == NotificationOfEmploymentContractType.Concluding) {
            this.model.newEmployeeRequests = [this.initNewEmployeeRequest()];

        } else if (this.model.notificationOfEmploymentContractType == NotificationOfEmploymentContractType.Terminating) {

            if (ObjectHelper.isNullOrUndefined(this.model.removeEmployeeRequests))
                this.model.removeEmployeeRequests = [];
        }
    }

    @action private initNewEmployeeRequest(): NewEmployeeRequest {
        let newEmployeeRequest = new NewEmployeeRequest();
        newEmployeeRequest.employee = new Employee();
        newEmployeeRequest.employee.employeeIdentifierType = EmployeeIdentifierType.EGN;
        newEmployeeRequest.contractType = ContractType.Unlimited;

        return newEmployeeRequest;
    }

    @action private initRemoveEmployeeRequest(): RemoveEmployeeRequest {
        var removeEmployeeRequest = new RemoveEmployeeRequest();
        removeEmployeeRequest.employee = new Employee();
        removeEmployeeRequest.employee.employeeIdentifierType = EmployeeIdentifierType.EGN;

        return removeEmployeeRequest;
    }

    //#endregion
}

export const NotificationForConcludingOrTerminatingEmploymentContractDataUI = withDocumentFormManager(NotificationForConcludingOrTerminatingEmploymentContractDataImpl);