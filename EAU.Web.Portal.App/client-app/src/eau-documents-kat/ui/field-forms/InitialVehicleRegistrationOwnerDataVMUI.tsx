import React from "react";
import { action } from 'mobx';
import { observer } from "mobx-react";
import { SelectListItem, ObjectHelper } from "cnsys-core";
import { BaseProps, ViewMode } from "cnsys-ui-react";
import { attributesClassFormControlReqired, attributesClassFormControlRequiredLabel, EAUBaseComponent, ResourceHelpers } from "eau-core";
import { ApplicationFormManagerProps, PersonIdentifier, PersonIdentifierChoiceType, withDocumentFormManager, ElectronicServiceAuthorQualityType, ApplicationType } from "eau-documents";
import { InitialVehicleRegistrationOwnerDataVM, PersonEntityChoiceType } from "../../models/ModelsAutoGenerated";
import { PersonIdentifierKATUI } from "./PersonIdentifierKATUI";
import { withApplicationForInitialVehicleRegistrationDataContext } from "../section-forms/withApplicationForInitialVehicleRegistrationDataContex";
import { IApplicationForInitialVehicleRegistrationDataContextProps } from "../section-forms/ApplicationForInitialVehicleRegistrationDataUI"

interface InitialVehicleRegistrationOwnerDataVMUIProps extends BaseProps, ApplicationFormManagerProps, IApplicationForInitialVehicleRegistrationDataContextProps {
    indexInCollection: number;
}

@observer class InitialVehicleRegistrationOwnerDataVMUIImpl extends EAUBaseComponent<InitialVehicleRegistrationOwnerDataVMUIProps, InitialVehicleRegistrationOwnerDataVM> {
    private peronEntityChoiceTypes: SelectListItem[];
    private cbOwnerOfVehicleRegistrationCouponId: string;
    private cbVehicleRepresentativeId: string;

    constructor(props?: InitialVehicleRegistrationOwnerDataVMUIProps, context?: any) {
        super(props, context);

        //Bind
        this.onOwnerTypeChange = this.onOwnerTypeChange.bind(this);
        this.onVehicleRepresentativeChange = this.onVehicleRepresentativeChange.bind(this);
        this.onOwnerOfVehicleRegistrationCouponChange = this.onOwnerOfVehicleRegistrationCouponChange.bind(this);

        //Init
        this.cbOwnerOfVehicleRegistrationCouponId = ObjectHelper.newGuid() + this.props.indexInCollection;
        this.cbVehicleRepresentativeId = ObjectHelper.newGuid() + this.props.indexInCollection;

        this.peronEntityChoiceTypes = [
            new SelectListItem({
                value: PersonEntityChoiceType.Person.toString(),
                text: this.getResource("DOC_GL_PersonAndEntityChoiceType_Person_L"),
                selected: this.model.type === PersonEntityChoiceType.Person
            }),
            new SelectListItem({
                value: PersonEntityChoiceType.Entity.toString(),
                text: this.getResource("DOC_KAT_LEGAL_ENTITY_OR_AGRICULTURAL_PRODUCER_L"),
                selected: this.model.type === PersonEntityChoiceType.Entity
            })
        ];
    }

    renderEdit(): JSX.Element {
        let authorQuality = this.props.documentFormManager.getSelectedAuthorQuality;

        return (
            <>
                <div className="row">
                    <div className="form-group col-12">
                        <fieldset>
                            <legend className="form-control-label">{this.getResourceByProperty(m => m.type)}</legend>
                            {((authorQuality != ElectronicServiceAuthorQualityType.Representative && this.props.indexInCollection == 0) || (this.props.documentFormManager.applicationType == ApplicationType.AppForRemoveInvalidData && this.props.indexInCollection == 0)) ?
                                <p className="field-text">
                                    {ResourceHelpers.getResourceByEmun(this.model.type as number, PersonEntityChoiceType)}
                                </p>
                                :
                                this.radioButtonListFor(m => m.type, this.peronEntityChoiceTypes, null, this.onOwnerTypeChange)}
                        </fieldset>
                    </div>
                </div>
                {this.model.type == PersonEntityChoiceType.Person ?
                    <PersonIdentifierKATUI
                        {...this.bind(m => m.personIdentifier)}
                        viewMode={this.props.documentFormManager.applicationType == ApplicationType.AppForRemoveInvalidData
                            && this.props.indexInCollection == 0 ? ViewMode.Display : this.props.viewMode} />
                    :
                    this.props.documentFormManager.applicationType == ApplicationType.AppForRemoveInvalidData
                        && this.props.indexInCollection == 0 ?
                        <div className="row">
                            <div className="form-group col-6">
                                <h4 className="form-control-label">{this.getResourceByProperty(x => x.entityIdentifier)}</h4>
                                {this.textDisplayFor(m => m.entityIdentifier)}
                            </div>
                        </div>
                        :
                        <div className="row">
                            <div className="col-12">
                                {this.labelFor(m => m.entityIdentifier, null, attributesClassFormControlRequiredLabel)}
                            </div>
                            <div className="form-group col col-sm-6">
                                {this.textBoxFor(m => m.entityIdentifier, attributesClassFormControlReqired)}
                            </div>
                        </div>}
                <div className="row">
                    <div className="form-group col-12">
                        <div className="custom-control custom-checkbox">
                            <input
                                id={this.cbOwnerOfVehicleRegistrationCouponId}
                                type="checkbox"
                                name={this.cbOwnerOfVehicleRegistrationCouponId}
                                className="custom-control-input"
                                value={this.model.isOwnerOfVehicleRegistrationCoupon === true ? 1 : 0}
                                checked={this.model.isOwnerOfVehicleRegistrationCoupon === true}
                                onChange={this.onOwnerOfVehicleRegistrationCouponChange}
                                disabled={(this.props.isOwnerOfVehicleRegistrationCouponMarked() === true && (ObjectHelper.isNullOrUndefined(this.model.isOwnerOfVehicleRegistrationCoupon) || this.model.isOwnerOfVehicleRegistrationCoupon === false))} />
                            <label htmlFor={this.cbOwnerOfVehicleRegistrationCouponId} className="custom-control-label">
                                {this.getResourceByProperty(m => m.isOwnerOfVehicleRegistrationCoupon)}
                            </label>
                        </div>
                        {this.model.type == PersonEntityChoiceType.Person &&
                            <div className="custom-control custom-checkbox">
                                <input
                                    id={this.cbVehicleRepresentativeId}
                                    type="checkbox"
                                    name={this.cbVehicleRepresentativeId}
                                    className="custom-control-input"
                                    value={this.model.isVehicleRepresentative === true ? 1 : 0}
                                    checked={this.model.isVehicleRepresentative === true}
                                    onChange={this.onVehicleRepresentativeChange}
                                    disabled={(this.props.isVehicleRepresentativeChoosen() === true && (ObjectHelper.isNullOrUndefined(this.model.isVehicleRepresentative) || this.model.isVehicleRepresentative === false))} />
                                <label htmlFor={this.cbVehicleRepresentativeId} className="custom-control-label">
                                    {this.getResourceByProperty(m => m.isVehicleRepresentative)}
                                </label>
                            </div>}
                    </div>
                </div>
            </>
        );
    }

    renderDisplay(): JSX.Element {
        return (
            <>
                <div className="row">
                    <div className="form-group col-12">
                        {/** Вид на лицето */}
                        <h4 className="form-control-label">{this.getResourceByProperty(m => m.type)}</h4>
                        <p className="field-text">
                            {this.model.type == PersonEntityChoiceType.Person && this.getResource("DOC_GL_PersonAndEntityChoiceType_Person_L")}
                            {this.model.type == PersonEntityChoiceType.Entity && this.getResource("DOC_KAT_LEGAL_ENTITY_OR_AGRICULTURAL_PRODUCER_L")}
                        </p>
                        {this.propertyErrorsDispleyFor(m => m.type)}
                    </div>
                </div>
                {this.model.type == PersonEntityChoiceType.Person ?
                    <PersonIdentifierKATUI {...this.bind(m => m.personIdentifier)} />
                    :
                    <div className="row">
                        <div className="form-group col-6">
                            <h4 className="form-control-label">{this.getResourceByProperty(x => x.entityIdentifier)}</h4>
                            {this.textDisplayFor(m => m.entityIdentifier)}
                        </div>
                    </div>}
                <div className="row">
                    <div className="form-group col-12">
                        {this.model.isOwnerOfVehicleRegistrationCoupon === true &&
                            < p className="field-text check-item check-success">
                                {this.getResourceByProperty(m => m.isOwnerOfVehicleRegistrationCoupon)}
                            </p>}
                    </div>
                    {this.model.type == PersonEntityChoiceType.Person && this.model.isVehicleRepresentative === true &&
                        <div className="form-group col-12">
                            <p className="field-text check-item check-success">
                                {this.getResourceByProperty(m => m.isVehicleRepresentative)}
                            </p>
                        </div>}
                </div>
            </>
        );
    }

    @action onOwnerTypeChange(e: any): void {
        let val: PersonEntityChoiceType = Number(e.target.value);

        if (val == PersonEntityChoiceType.Person) {
            this.model.type = PersonEntityChoiceType.Person;
            this.model.entityIdentifier = undefined;
            this.model.personIdentifier = new PersonIdentifier();
            this.model.personIdentifier.itemElementName = PersonIdentifierChoiceType.EGN;
        } else {
            this.model.type = PersonEntityChoiceType.Entity;
            this.model.personIdentifier = undefined;
            this.model.entityIdentifier = undefined;
        }

        this.model.isVehicleRepresentative = false;
    }

    @action private onOwnerOfVehicleRegistrationCouponChange(e: any): void {
        this.model.isOwnerOfVehicleRegistrationCoupon = e.target.value == "0" ? true : false;

        if (this.props.onChangeOwnerOfVehicleRegistrationCoupon) {
            this.props.onChangeOwnerOfVehicleRegistrationCoupon(this.model.isOwnerOfVehicleRegistrationCoupon);
        }
    }

    @action private onVehicleRepresentativeChange(e: any): void {
        this.model.isVehicleRepresentative = e.target.value == "0" ? true : false;
    }
}

export const InitialVehicleRegistrationOwnerDataVMUI = withDocumentFormManager(withApplicationForInitialVehicleRegistrationDataContext(InitialVehicleRegistrationOwnerDataVMUIImpl));