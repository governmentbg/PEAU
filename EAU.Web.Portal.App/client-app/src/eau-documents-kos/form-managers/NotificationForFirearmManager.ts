import { ResourceHelpers } from 'eau-core';
import { ApplicationFormManagerBase, ApplicationType, DocumentFormValidationContext, ElectronicServiceAuthorQualityType, PersonAddress, PersonalInformationVM, Section } from 'eau-documents';
import { action } from 'mobx';
import { NotificationForFirearmVM } from '../models/ModelsAutoGenerated';
import { NotificationForFirearmDataUI } from '../ui/section-forms/NotificationForFirearmDataUI';
import { NotificationForFirearmDataValidator } from '../validations/NotificationForFirearmDataValidator';

export class NotificationForFirearmManager extends ApplicationFormManagerBase<NotificationForFirearmVM>{

    //#region ApplicationFormManagerBase

    protected createDocument(obj: any): NotificationForFirearmVM {
        return new NotificationForFirearmVM(obj);
    }

    //#endregion

    @action protected initDocumentForm() {
        super.initDocumentForm();

        if (!this.documentForm.circumstances.applicantInformation)
            this.documentForm.circumstances.applicantInformation = new PersonalInformationVM();

        if (!this.documentForm.circumstances.applicantInformation.personAddress)
            this.setPersonAddress(this.documentForm.electronicServiceApplicant.recipientGroup.authorWithQuality.selectedAuthorQuality);
    }

    @action protected createSections(validationContext: DocumentFormValidationContext): Section[] {
        var sections = super.createSections(validationContext);

        var circumstances = new Section();
        circumstances.code = "circumstances";
        circumstances.title = ResourceHelpers.getResourceByProperty(m => m.circumstances, this.documentForm);
        circumstances.form = this.documentForm.circumstances;
        circumstances.formUICmp = NotificationForFirearmDataUI;
        circumstances.validator = new NotificationForFirearmDataValidator();
        circumstances.validator.setValidationContext(validationContext);
        circumstances.validate = () => this.validateSection(circumstances);

        sections.splice(1, 0, circumstances);

        return sections;
    }

    public changeAuthorQuality(qualityType: ElectronicServiceAuthorQualityType) {
        super.changeAuthorQuality(qualityType);

        this.setPersonAddress(qualityType);
    }

    //#region helpers

    private setPersonAddress(qualityType: ElectronicServiceAuthorQualityType) {

        if (this.applicationType != ApplicationType.AppForRemoveInvalidData) {
            if (qualityType == ElectronicServiceAuthorQualityType.Personal)
                this.documentForm.circumstances.applicantInformation.personAddress = this.documentForm.circumstances.persistedPersonAddress;
            else
                this.documentForm.circumstances.applicantInformation.personAddress = new PersonAddress();
        }
    }

    //#endregion
}